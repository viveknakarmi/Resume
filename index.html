<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Interactive Resume City</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #14141E, #1E3A5F);
            color: #FFFFFF;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 90vw;
            max-width: 900px;
            height: 70vh;
            max-height: 600px;
            border: 2px solid #00DDEB;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(20, 20, 30, 0.9);
        }
        #game-canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            transition: filter 0.3s ease;
        }
        #game-canvas.blur {
            filter: blur(3px);
        }
        .popup {
            display: none;
            position: fixed;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid #00DDEB;
            border-radius: 8px;
            padding: 1.5rem;
            width: 85vw;
            max-width: 400px;
            min-height: 200px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 0 20px rgba(0, 221, 235, 0.5);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease, top 0.3s ease;
        }
        .popup.active {
            display: block;
            top: 50%;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .popup:hover {
            transform: translate(-50%, -50%) scale(1.02);
        }
        .popup h2 {
            color: #FFFFFF;
            font-size: 1.8rem;
            margin: 0 0 0.8rem;
            font-weight: 700;
        }
        .popup p, .popup li {
            color: #A3BFFA;
            font-size: 1rem;
            line-height: 1.6;
            text-align: left;
        }
        .popup ul {
            list-style: disc;
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        .popup a {
            color: #00DDEB;
            text-decoration: none;
        }
        .popup a:hover {
            text-decoration: underline;
        }
        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-btn:hover {
            color: #00DDEB;
        }
        .instructions {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 1rem;
            color: #A3BFFA;
        }
        .progress-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 120px;
            height: 12px;
            background: #2A2A3A;
            border: 1px solid #00DDEB;
            border-radius: 4px;
        }
        .progress-fill {
            height: 100%;
            background: #00DDEB;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .timeline-link, .editor-link {
            background: #00DDEB;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            color: #14141E;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s ease;
            margin: 0 0.5rem;
        }
        .button-container {
            position: absolute;
            top: 10px;
            display: flex;
            justify-content: space-between;
            width: 90vw;
            max-width: 900px;
            z-index: 15;
        }
        .timeline-link:hover, .editor-link:hover {
            background: #00B7C2;
        }
        .welcome-popup {
            position: fixed;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid #00DDEB;
            border-radius: 8px;
            padding: 1.5rem;
            width: 85vw;
            max-width: 400px;
            z-index: 20;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease, top 0.3s ease;
        }
        .welcome-popup.active {
            display: block;
            top: 50%;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .tooltip {
            position: absolute;
            background: rgba(0, 221, 235, 0.9);
            color: #14141E;
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 5;
            display: none;
        }
        .controls {
            position: fixed;
            bottom: 15px;
            width: 90vw;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            z-index: 15;
        }
        .control-btn {
            background: #00DDEB;
            color: #14141E;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            touch-action: manipulation;
        }
        .control-btn:active {
            opacity: 1;
            transform: scale(0.95);
        }
        .left-right {
            display: flex;
            gap: 15px;
        }
        @media (min-width: 768px) {
            .controls {
                display: none;
            }
            .instructions {
                display: block;
            }
            .instructions-mobile {
                display: none;
            }
        }
        @media (max-width: 767px) {
            .instructions {
                display: none;
            }
            .instructions-mobile {
                text-align: center;
                margin-top: 0.5rem;
                font-size: 0.9rem;
                color: #A3BFFA;
                display: block;
            }
            #game-container {
                height: 60vh;
            }
            .popup h2 {
                font-size: 1.6rem;
            }
            .popup p, .popup li {
                font-size: 0.95rem;
            }
        }
    </style>
    <script>
        function closePopup(id) {
            document.getElementById(id).classList.remove('active');
            document.getElementById('game-canvas').classList.remove('blur');
        }

        function closeAllPopups() {
            document.querySelectorAll('.popup, .welcome-popup').forEach(popup => {
                popup.classList.remove('active');
            });
            document.getElementById('game-canvas').classList.remove('blur');
        }
    </script>
</head>
<body>
    <div class="button-container">
        <a href="timeline.html" class="timeline-link">Career Timeline</a>
        <a href="editor.html" class="editor-link">Edit Resume</a>
    </div>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>
    <div class="instructions">Use Arrow Keys/WASD to move, Space to jump, Enter to interact, Esc to close popups</div>
    <div class="instructions-mobile">Use on-screen buttons to move, jump, and interact</div>

    <!-- Welcome Popup -->
    <div class="welcome-popup active" id="welcome-popup">
        <button class="close-btn" onclick="closePopup('welcome-popup')">×</button>
        <h2>Welcome to My Resume City!</h2>
        <p>Passionate about data analytics and payroll efficiency. Skilled in SQL, Looker Studio, and VBA. Explore my career in this vibrant city! On desktop, use Arrow Keys or WASD to move, Space to jump, and Enter to interact. On mobile, use the on-screen buttons. The current role pulses with energy. Press the close button to close popups. Follow the glowing timeline across 5-year levels (2013–2017 at the bottom, 2018–2022 in the middle, 2023–Present at the top). Below lies a bustling underground metro—observe its vibrancy! Check out my <a href="https://www.linkedin.com/in/vivek-anand-nakarmi-9b8a42a3" target="_blank">LinkedIn</a> or view the Career Timeline link!</p>
        <div class="btn" onclick="closePopup('welcome-popup')">Start Exploring</div>
    </div>

    <!-- Dynamic Popups Container -->
    <div id="popups-container"></div>

    <!-- Touch Controls -->
    <div class="controls">
        <div class="left-right">
            <button class="control-btn" id="left-btn">←</button>
            <button class="control-btn" id="right-btn">→</button>
        </div>
        <div class="actions">
            <button class="control-btn" id="jump-btn">Jump</button>
            <button class="control-btn" id="interact-btn">Interact</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Canvas context not supported');
            throw new Error('Canvas context not supported');
        }

        // Responsive canvas size with device pixel ratio
        const gameContainer = document.getElementById('game-container');
        const dpr = window.devicePixelRatio || 1;

        function resizeCanvas() {
            canvas.width = gameContainer.clientWidth * dpr;
            canvas.height = gameContainer.clientHeight * dpr;
            canvas.style.width = `${gameContainer.clientWidth}px`;
            canvas.style.height = `${gameContainer.clientHeight}px`;
            ctx.scale(dpr, dpr);
        }

        resizeCanvas();

        // Handle orientation change
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('orientationchange', resizeCanvas);

        // Scale factors for responsive rendering
        const baseWidth = 900;
        const baseHeight = 800;
        let scaleX = canvas.width / dpr / baseWidth;
        let scaleY = canvas.height / dpr / baseHeight;
        if (window.innerWidth <= 767) {
            scaleX *= 1.2;
            scaleY *= 1.2;
        }

        const player = {
            x: 150 * scaleX,
            y: 626 * scaleY,
            width: 24 * scaleX * (window.innerWidth <= 767 ? 1.5 : 1),
            height: 36 * scaleY * (window.innerWidth <= 767 ? 1.5 : 1),
            speed: 3 * scaleX * (window.innerWidth <= 767 ? 1.2 : 1),
            vy: 0,
            jumpPower: -13 * scaleY * (window.innerWidth <= 767 ? 1.3 : 1),
            gravity: 0.5 * scaleY,
            grounded: true
        };

        const platforms = [
            { x: 0, y: 650 * scaleY, width: 900 * scaleX, height: 20 * scaleY },
            { x: 100 * scaleX, y: 450 * scaleY, width: 700 * scaleX, height: 20 * scaleY },
            { x: 0, y: 250 * scaleY, width: 700 * scaleX, height: 20 * scaleY },
            { x: 100 * scaleX, y: 600 * scaleY, width: 50 * scaleX, height: 10 * scaleY },
            { x: 750 * scaleX, y: 600 * scaleY, width: 50 * scaleX, height: 10 * scaleY },
            { x: 100 * scaleX, y: 400 * scaleY, width: 50 * scaleX, height: 10 * scaleY },
            { x: 750 * scaleX, y: 400 * scaleY, width: 50 * scaleX, height: 10 * scaleY }
        ];

        const signs = [
            { x: 190 * scaleX, y: 510 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Intern at Cerno' },
            { x: 390 * scaleX, y: 510 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Intern Accountant' },
            { x: 590 * scaleX, y: 510 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Payroll Officer RASHAYS' },
            { x: 590 * scaleX, y: 350 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Payroll Officer Consortio' },
            { x: 390 * scaleX, y: 340 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Payroll Team Leader' },
            { x: 190 * scaleX, y: 330 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Payroll Manager' },
            { x: 190 * scaleX, y: 150 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Data Manager' },
            { x: 390 * scaleX, y: 150 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Education' },
            { x: 590 * scaleX, y: 150 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Skills' },
            { x: 790 * scaleX, y: 150 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Projects' }
        ];

        let savedLocations = JSON.parse(localStorage.getItem('resumeLocations')) || [
            { id: 'intern-cerno', title: 'Intern at Cerno', content: '<p>Mar 2013 – Jun 2013 | St. Leonards, Sydney</p><p>Responsibilities:</p><ul><li>Compared bank statements with Navision journals.</li><li>Checked invoice status and payment details.</li><li>Assisted with financial data verification.</li><li>Supported team with administrative tasks.</li></ul>', startYear: 2013, endYear: 2013, layer: 'bottom', x: 200 * scaleX, y: 610 * scaleY, width: 40 * scaleX, height: 40 * scaleY, groundY: 650 * scaleY, timelineOrder: 1 },
            { id: 'intern-accountant', title: 'Intern Assistant Accountant', content: '<p>Feb 2015 – Nov 2015 | Surry Hills, Sydney</p><p>Responsibilities:</p><ul><li>Managed accounts payable/receivable using MYOB.</li><li>Reconciled bank accounts and payroll sheets.</li><li>Prepared Business Activity Statements (BAS).</li><li>Performed cost center analysis with Excel.</li></ul>', startYear: 2015, endYear: 2015, layer: 'bottom', x: 400 * scaleX, y: 600 * scaleY, width: 40 * scaleX, height: 50 * scaleY, groundY: 650 * scaleY, timelineOrder: 2 },
            { id: 'payroll-officer-rashays', title: 'Payroll Officer at RASHAYS', content: '<p>Nov 2015 – Oct 2018 | Sydney, Australia</p><p>Responsibilities:</p><ul><li>Processed payroll for restaurant staff accurately.</li><li>Maintained employee records and leave balances.</li><li>Ensured compliance with payroll regulations.</li><li>Generated reports using Excel for management.</li></ul>', startYear: 2015, endYear: 2018, layer: 'bottom', x: 600 * scaleX, y: 590 * scaleY, width: 40 * scaleX, height: 60 * scaleY, groundY: 650 * scaleY, timelineOrder: 3 },
            { id: 'payroll-officer-consortio', title: 'Payroll Officer at Consortio', content: '<p>Oct 2018 – Mar 2021 | Sydney, Australia</p><p>Responsibilities:</p><ul><li>Ensured accurate salary disbursement and compliance.</li><li>Managed overpayment recovery and leave records.</li><li>Prepared reports within regulatory timeframes.</li><li>Used Excel and payroll systems for data tasks.</li></ul>', startYear: 2018, endYear: 2021, layer: 'middle', x: 600 * scaleX, y: 410 * scaleY, width: 40 * scaleX, height: 40 * scaleY, groundY: 450 * scaleY, timelineOrder: 4 },
            { id: 'payroll-team-leader', title: 'Payroll Team Leader at Consortio', content: '<p>Mar 2021 – Nov 2021 | Australia</p><p>Responsibilities:</p><ul><li>Led payroll team to ensure timely processing.</li><li>Implemented process improvements for efficiency.</li><li>Ensured data accuracy across payroll systems.</li><li>Supported compliance with payroll regulations.</li></ul>', startYear: 2021, endYear: 2021, layer: 'middle', x: 400 * scaleX, y: 400 * scaleY, width: 40 * scaleX, height: 50 * scaleY, groundY: 450 * scaleY, timelineOrder: 5 },
            { id: 'payroll-manager', title: 'Payroll Manager at Consortio', content: '<p>Nov 2021 – Jun 2023 | Sydney, NSW, Australia</p><p>Responsibilities:</p><ul><li>Oversaw payroll processing for accuracy and compliance.</li><li>Developed reports using SQL and Excel for insights.</li><li>Streamlined payroll workflows with VBA automation.</li><li>Trained team on payroll systems and data tools.</li></ul>', startYear: 2021, endYear: 2023, layer: 'middle', x: 200 * scaleX, y: 390 * scaleY, width: 40 * scaleX, height: 60 * scaleY, groundY: 450 * scaleY, timelineOrder: 6 },
            { id: 'data-manager', title: 'Data Manager at Consortio', content: '<p>Jul 2023 – Present | Sydney, NSW, Australia</p><p>Responsibilities:</p><ul><li>Led data strategy and analytics initiatives.</li><li>Built and maintained dashboards using Looker Studio.</li><li>Managed large datasets with SQL and Google BigQuery.</li><li>Collaborated with teams to drive data-driven decisions.</li></ul>', startYear: 2023, endYear: 'Present', layer: 'top', x: 200 * scaleX, y: 170 * scaleY, width: 60 * scaleX, height: 80 * scaleY, groundY: 250 * scaleY, timelineOrder: 7, isPresent: true },
            { id: 'education', title: 'Education', content: '<p>Academic Background:</p><ul><li>Diploma in Accounting, Sydney TAFE, 2013.</li><li>Completed courses in SQL and Data Visualization.</li><li>Certified in Advanced Excel and VBA Programming.</li><li>Studied Business Analytics short course, UNSW, 2020.</li></ul>', startYear: null, endYear: null, layer: 'top', x: 400 * scaleX, y: 210 * scaleY, width: 40 * scaleX, height: 40 * scaleY, groundY: 250 * scaleY },
            { id: 'skills', title: 'Skills', content: '<p>Core Competencies:</p><ul><li>Data Analysis & Modeling</li><li>SQL & Google BigQuery</li><li>Looker Studio & Data Visualization</li><li>Microsoft Excel & VBA</li><li>Payroll Services & Data Management</li></ul>', startYear: null, endYear: null, layer: 'top', x: 600 * scaleX, y: 210 * scaleY, width: 40 * scaleX, height: 40 * scaleY, groundY: 250 * scaleY },
            { id: 'projects', title: 'Projects', content: '<p>Key Achievements in Data Analytics:</p><ul><li>Built a dashboard app for payroll insights using Looker Studio.</li><li>Automated data cleaning with VBA scripts for Consortio.</li><li>Designed SQL queries for real-time reporting at RASHAYS.</li><li>Created predictive models for workforce planning.</li></ul>', startYear: null, endYear: null, layer: 'top', x: 800 * scaleX, y: 210 * scaleY, width: 40 * scaleX, height: 40 * scaleY, groundY: 250 * scaleY },
            { id: 'achievements', title: 'Achievements', content: '<p>Career Highlights:</p><ul><li>Certified Data Analyst, 2023.</li><li>Streamlined payroll systems at Consortio, saving 20% time.</li><li>Completed over 100 dashboards for business insights.</li><li>Mentored payroll team to improve accuracy.</li></ul>', startYear: null, endYear: null, layer: 'top', x: 800 * scaleX, y: 210 * scaleY, width: 40 * scaleX, height: 40 * scaleY, groundY: 250 * scaleY, locked: true }
        ];

        const locations = savedLocations.map(loc => ({
            ...loc,
            radiating: false,
            pulseVisited: false,
            draw: drawBuilding,
            tooltip: loc.startYear ? `${loc.startYear}${loc.endYear === 'Present' ? '–Present' : loc.endYear ? '–' + loc.endYear : ''}: ${loc.title}` : loc.title
        }));

        const popupsContainer = document.getElementById('popups-container');
        locations.forEach(loc => {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.id = loc.id + '-popup';
            popup.innerHTML = `
                <button class="close-btn" onclick="closePopup('${loc.id}-popup')">×</button>
                <h2>${loc.title}</h2>
                ${loc.content}
            `;
            popupsContainer.appendChild(popup);
        });

        const cars = [
            { x: 0, y: 780 * scaleY, width: 40 * scaleX, height: 15 * scaleY, speed: 2 * scaleX, color: '#00DDEB' },
            { x: 300 * scaleX, y: 780 * scaleY, width: 40 * scaleX, height: 15 * scaleY, speed: -1.5 * scaleX, color: '#A3BFFA' }
        ];
        const train = { x: 0, y: 300 * scaleY, width: 100 * scaleX, height: 20 * scaleY, speed: 1.5 * scaleX, color: '#A3BFFA' };
        const stars = Array.from({ length: 50 }, () => ({
            x: Math.random() * gameContainer.clientWidth,
            y: Math.random() * gameContainer.clientHeight * 0.3,
            radius: Math.random() * 2 * scaleX,
            opacity: Math.random()
        }));
        const distantBuildings = [
            { x: 0, y: 600 * scaleY, width: 30 * scaleX, height: 50 * scaleY },
            { x: 50 * scaleX, y: 600 * scaleY, width: 30 * scaleX, height: 60 * scaleY },
            { x: 100 * scaleX, y: 600 * scaleY, width: 30 * scaleX, height: 40 * scaleY },
            { x: 800 * scaleX, y: 600 * scaleY, width: 30 * scaleX, height: 50 * scaleY }
        ];
        const undergroundTrains = [
            { x: 0, y: 700 * scaleY, width: 80 * scaleX, height: 20 * scaleY, speed: 1 * scaleX },
            { x: 200 * scaleX, y: 720 * scaleY, width: 80 * scaleX, height: 20 * scaleY, speed: -0.8 * scaleX },
            { x: 400 * scaleX, y: 740 * scaleY, width: 80 * scaleX, height: 20 * scaleY, speed: 0.6 * scaleX }
        ];
        const undergroundSigns = [
            { x: 100 * scaleX, y: 680 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Metro' },
            { x: 300 * scaleX, y: 680 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Station' },
            { x: 500 * scaleX, y: 680 * scaleY, width: 20 * scaleX, height: 10 * scaleY, label: 'Exit' }
        ];

        function drawBuilding(x, y, width, height, tooltip, groundY, isPresent, loc) {
            const baseY = groundY - height;
            ctx.save();
            const gradient = ctx.createLinearGradient(x, baseY, x, baseY + height);
            gradient.addColorStop(0, '#2A2A3A');
            gradient.addColorStop(1, '#3A3A4A');
            ctx.fillStyle = gradient;
            ctx.strokeStyle = '#00DDEB';
            ctx.lineWidth = 0.5 * scaleX;

            try {
                ctx.beginPath();
                if (loc.id === 'intern-cerno') {
                    ctx.moveTo(x, baseY);
                    ctx.lineTo(x + width, baseY);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x, baseY + height);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = '#00DDEB';
                    ctx.fillRect(x + width / 2 - 2 * scaleX, baseY - 10 * scaleY, 4 * scaleX, 10 * scaleY);
                } else if (loc.id === 'intern-accountant') {
                    ctx.moveTo(x, baseY);
                    ctx.lineTo(x + width, baseY + 10 * scaleY);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x, baseY + height);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else if (loc.id === 'payroll-officer-rashays') {
                    ctx.moveTo(x, baseY + 20 * scaleY);
                    ctx.lineTo(x, baseY + height);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x + width, baseY + 20 * scaleY);
                    ctx.quadraticCurveTo(x + width / 2, baseY, x, baseY + 20 * scaleY);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else if (loc.id === 'payroll-officer-consortio') {
                    ctx.moveTo(x, baseY);
                    ctx.lineTo(x + width, baseY);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x, baseY + height);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = '#00DDEB';
                    ctx.fillRect(x + width / 2 - 5 * scaleX, baseY - 5 * scaleY, 10 * scaleX, (Math.random() * (10 - 5) + 5) * scaleY);
                } else if (loc.id === 'payroll-team-leader') {
                    ctx.moveTo(x, baseY + 5 * scaleY);
                    ctx.lineTo(x + width / 2, baseY);
                    ctx.lineTo(x + width, baseY + 5 * scaleY);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x, baseY + height);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else if (loc.id === 'payroll-manager') {
                    ctx.moveTo(x + 5 * scaleX, baseY);
                    ctx.lineTo(x + width - 5 * scaleX, baseY);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x, baseY + height);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else if (loc.id === 'data-manager') {
                    ctx.moveTo(x, baseY + 20 * scaleY);
                    ctx.lineTo(x, baseY + height);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x + width, baseY + 20 * scaleY);
                    ctx.quadraticCurveTo(x + width / 2, baseY - 10 * scaleY, x, baseY + 20 * scaleY);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                } else {
                    ctx.moveTo(x, baseY);
                    ctx.lineTo(x + width, baseY);
                    ctx.lineTo(x + width, baseY + height);
                    ctx.lineTo(x, baseY + height);
                    ctx.closePath();
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = '#00DDEB';
                    ctx.fillRect(x + width / 2 - 3 * scaleX, baseY - 5 * scaleY, 6 * scaleX, 5 * scaleY);
                }

                const rows = height >= 80 * scaleY ? 8 : 6;
                const cols = 4;
                const windowWidth = 6 * scaleX * (window.innerWidth <= 767 ? 1.3 : 1);
                const windowHeight = 4 * scaleY * (window.innerWidth <= 767 ? 1.3 : 1);
                let offsetY = height >= 80 * scaleY ? 16 * scaleY : 12 * scaleY;
                if (loc.id === 'intern-cerno') offsetY = 14 * scaleY;
                if (loc.id === 'payroll-officer-consortio') offsetY = 10 * scaleY;
                if (loc.id === 'payroll-officer-rashays') offsetY = 20 * scaleY;
                const offsetX = (width - cols * windowWidth - (cols - 1) * 2 * scaleX) / 2;
                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        let yPos = baseY + offsetY + i * (windowHeight + 2 * scaleY);
                        if (loc.id === 'intern-accountant') {
                            yPos += ((cols - 1 - j) / (cols - 1)) * 8 * scaleY;
                        } else if (loc.id === 'payroll-officer-rashays' && i === 0) {
                            yPos += Math.abs(j - 1.5) * 3 * scaleY;
                        } else if (loc.id === 'payroll-manager') {
                            const taperOffset = (cols - 1 - j) < cols / 2 ? (cols - 1 - j) : j;
                            yPos += (taperOffset * 1.5 * scaleY);
                        }
                        if (yPos + windowHeight <= groundY) {
                            ctx.fillStyle = '#00DDEB';
                            ctx.fillRect(
                                x + offsetX + j * (windowWidth + 2 * scaleX),
                                yPos,
                                windowWidth,
                                windowHeight
                            );
                            ctx.strokeStyle = '#FFFFFF';
                            ctx.lineWidth = 0.5 * scaleX;
                            ctx.strokeRect(
                                x + offsetX + j * (windowWidth + 2 * scaleX),
                                yPos,
                                windowWidth,
                                windowHeight
                            );
                        }
                    }
                }

                if (isPresent) {
                    ctx.strokeStyle = '#00DDEB';
                    ctx.globalAlpha = pulseOpacity;
                    ctx.lineWidth = 3 * scaleX;
                    ctx.strokeRect(x - 2 * scaleX, baseY - 2 * scaleY, width + 4 * scaleX, height + 4 * scaleY);
                    ctx.globalAlpha = 1;
                }
                if (loc.pulseVisited && !isPresent) {
                    ctx.strokeStyle = '#00DDEB';
                    ctx.globalAlpha = pulseOpacity;
                    ctx.lineWidth = 2 * scaleX;
                    ctx.strokeRect(x - 1 * scaleX, baseY - 1 * scaleY, width + 2 * scaleX, height + 2 * scaleY);
                    ctx.globalAlpha = 1;
                }
            } catch (error) {
                console.error(`Error drawing building ${loc.id}:`, error);
                ctx.fillRect(x, baseY, width, height);
                ctx.strokeRect(x, baseY, width, height);
            }
            ctx.restore();
        }

        function drawCar(car) {
            ctx.fillStyle = car.color;
            ctx.fillRect(car.x, car.y, car.width, car.height);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(car.x + 5 * scaleX, car.y + 2 * scaleY, 8 * scaleX, 5 * scaleY);
            ctx.fillRect(car.x + 27 * scaleX, car.y + 2 * scaleY, 8 * scaleX, 5 * scaleY);
        }

        function drawTrain(train) {
            ctx.fillStyle = train.color;
            ctx.fillRect(train.x, train.y, train.width, train.height);
            ctx.fillStyle = '#FFFFFF';
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(train.x + 10 * scaleX + i * 30 * scaleX, train.y + 2 * scaleY, 10 * scaleX, 10 * scaleY);
            }
        }

        function drawUndergroundTrain(train) {
            ctx.fillStyle = '#FF8C00';
            ctx.fillRect(train.x, train.y, train.width, train.height);
            ctx.fillStyle = '#FFFFE0';
            for (let i = 0; i < 2; i++) {
                ctx.fillRect(train.x + 10 * scaleX + i * 30 * scaleX, train.y + 2 * scaleY, 10 * scaleX, 10 * scaleY);
            }
        }

        function drawSign(sign) {
            ctx.fillStyle = '#00DDEB';
            ctx.fillRect(sign.x, sign.y, sign.width, sign.height);
            ctx.font = `${12 * scaleX}px Inter`;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillText(sign.label, sign.x + 2 * scaleX, sign.y + 8 * scaleY);
        }

        function drawDistantBuilding(building) {
            ctx.fillStyle = '#1E3A5F';
            ctx.fillRect(building.x, building.y - building.height, building.width, building.height);
        }

        let xp = 0;
        const visited = new Set();
        let achievementsUnlocked = false;
        let pulseOpacity = 0.4;
        let pulseDirection = 1;
        let nearestLoc = null;
        let minDistance = Infinity;

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        document.body.appendChild(tooltip);

        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (e.code === 'Space' && player.grounded) {
                player.vy = player.jumpPower;
                player.grounded = false;
            }
            if (e.code === 'Enter') {
                checkInteraction();
            }
            if (e.code === 'Escape') closeAllPopups();
        });
        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        // Touch Controls
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const jumpBtn = document.getElementById('jump-btn');
        const interactBtn = document.getElementById('interact-btn');

        leftBtn.addEventListener('touchstart', (e) => { e.preventDefault(); keys['a'] = true; });
        leftBtn.addEventListener('touchend', () => keys['a'] = false);
        rightBtn.addEventListener('touchstart', (e) => { e.preventDefault(); keys['d'] = true; });
        rightBtn.addEventListener('touchend', () => keys['d'] = false);
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (player.grounded) {
                player.vy = player.jumpPower;
                player.grounded = false;
            }
        });
        interactBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            checkInteraction();
        });

        function update() {
            try {
                let isMoving = false;
                if (keys['arrowleft'] || keys['a']) {
                    player.x -= player.speed;
                    isMoving = true;
                }
                if (keys['arrowright'] || keys['d']) {
                    player.x += player.speed;
                    isMoving = true;
                }

                player.vy += player.gravity;
                player.y += player.vy;

                player.grounded = false;
                const allPlatforms = [
                    ...platforms,
                    ...locations.map(loc => ({
                        x: loc.x,
                        y: loc.groundY - loc.height,
                        width: loc.width,
                        height: loc.height
                    })),
                    ...cars.map(car => ({
                        x: car.x,
                        y: car.y,
                        width: car.width,
                        height: car.height
                    })),
                    { x: train.x, y: train.y, width: train.width, height: train.height }
                ];

                allPlatforms.forEach(platform => {
                    if (
                        player.x + player.width > platform.x &&
                        player.x < platform.x + platform.width &&
                        player.y + player.height > platform.y &&
                        player.y + player.height - player.vy <= platform.y &&
                        player.vy >= 0
                    ) {
                        player.y = platform.y - player.height;
                        player.vy = 0;
                        player.grounded = true;
                    }
                });

                player.x = Math.max(0, Math.min(gameContainer.clientWidth - player.width, player.x));
                player.y = Math.min(650 * scaleY - player.height, player.y);

                pulseOpacity += pulseDirection * 0.02;
                if (pulseOpacity >= 0.8 || pulseOpacity <= 0.4) pulseDirection *= -1;

                cars.forEach(car => {
                    car.x += car.speed;
                    if (car.x > gameContainer.clientWidth) car.x = -car.width;
                    if (car.x + car.width < 0) car.x = gameContainer.clientWidth;
                });
                train.x += train.speed;
                if (train.x > gameContainer.clientWidth) train.x = -train.width;
                undergroundTrains.forEach(train => {
                    train.x += train.speed;
                    if (train.x > gameContainer.clientWidth) train.x = -train.width;
                    if (train.x + train.width < 0) train.x = gameContainer.clientWidth;
                });
                stars.forEach(star => {
                    star.opacity = (star.opacity + 0.01) % 1;
                });

                const isPopupActive = Array.from(document.querySelectorAll('.popup, .welcome-popup')).some(p => p.classList.contains('active'));
                canvas.classList.toggle('blur', isPopupActive);

                ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);

                const gradient = ctx.createLinearGradient(0, 0, 0, gameContainer.clientHeight);
                gradient.addColorStop(0, '#14141E');
                gradient.addColorStop(0.8, '#1E3A5F');
                gradient.addColorStop(1, '#3A3A4A');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, gameContainer.clientWidth, gameContainer.clientHeight);

                stars.forEach(star => {
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                    ctx.fill();
                });

                distantBuildings.forEach(drawDistantBuilding);

                ctx.fillStyle = '#3A3A4A';
                ctx.fillRect(0, 290 * scaleY, gameContainer.clientWidth, 5 * scaleY);
                ctx.fillStyle = '#00DDEB';
                ctx.fillRect(0, 295 * scaleY, gameContainer.clientWidth, 5 * scaleY);

                drawTrain(train);

                ctx.fillStyle = '#3A3A4A';
                platforms.forEach(platform => {
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    ctx.strokeStyle = '#00DDEB';
                    ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
                });

                nearestLoc = null;
                minDistance = Infinity;
                locations.forEach((loc, index) => {
                    if (loc.locked && !achievementsUnlocked) return;
                    const dx = player.x + player.width / 2 - (loc.x + loc.width / 2);
                    const dy = player.y + player.height / 2 - (loc.groundY - loc.height / 2);
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const isNear = distance < 50 * scaleX;

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestLoc = loc;
                    }

                    loc.draw(loc.x, loc.groundY, loc.width, loc.height, loc.tooltip, loc.groundY, loc.isPresent, loc);

                    if (isNear && !visited.has(loc.id) && !loc.locked) {
                        xp += 10;
                        visited.add(loc.id);
                        loc.pulseVisited = true;
                        if (xp >= 100 && !achievementsUnlocked) {
                            achievementsUnlocked = true;
                            locations.find(l => l.id === 'achievements').locked = false;
                            document.getElementById('achievements-popup').classList.add('active');
                        }
                    }
                    if (visited.has(loc.id) && !loc.pulseVisited) {
                        loc.pulseVisited = true;
                    }
                });

                const timelineLocs = locations.filter(loc => loc.timelineOrder).sort((a, b) => a.timelineOrder - b.timelineOrder);
                ctx.strokeStyle = '#00DDEB';
                ctx.globalAlpha = 0.1;
                ctx.lineWidth = 2 * scaleX;
                ctx.beginPath();
                ctx.moveTo(timelineLocs[0].x + timelineLocs[0].width / 2, timelineLocs[0].groundY - timelineLocs[0].height / 2);
                ctx.lineTo(timelineLocs[1].x + timelineLocs[1].width / 2, timelineLocs[1].groundY - timelineLocs[1].height / 2);
                ctx.lineTo(timelineLocs[2].x + timelineLocs[2].width / 2, timelineLocs[2].groundY - timelineLocs[2].height / 2);
                ctx.lineTo(timelineLocs[3].x + timelineLocs[3].width / 2, timelineLocs[3].groundY - timelineLocs[3].height / 2);
                ctx.lineTo(timelineLocs[4].x + timelineLocs[4].width / 2, timelineLocs[4].groundY - timelineLocs[4].height / 2);
                ctx.lineTo(timelineLocs[5].x + timelineLocs[5].width / 2, timelineLocs[5].groundY - timelineLocs[5].height / 2);
                ctx.lineTo(timelineLocs[6].x + timelineLocs[6].width / 2, timelineLocs[6].groundY - timelineLocs[6].height / 2);
                ctx.stroke();
                ctx.globalAlpha = 0.7;
                ctx.lineWidth = 1 * scaleX;
                ctx.beginPath();
                ctx.moveTo(timelineLocs[0].x + timelineLocs[0].width / 2, timelineLocs[0].groundY - timelineLocs[0].height / 2);
                ctx.lineTo(timelineLocs[1].x + timelineLocs[1].width / 2, timelineLocs[1].groundY - timelineLocs[1].height / 2);
                ctx.lineTo(timelineLocs[2].x + timelineLocs[2].width / 2, timelineLocs[2].groundY - timelineLocs[2].height / 2);
                ctx.lineTo(timelineLocs[3].x + timelineLocs[3].width / 2, timelineLocs[3].groundY - timelineLocs[3].height / 2);
                ctx.lineTo(timelineLocs[4].x + timelineLocs[4].width / 2, timelineLocs[4].groundY - timelineLocs[4].height / 2);
                ctx.lineTo(timelineLocs[5].x + timelineLocs[5].width / 2, timelineLocs[5].groundY - timelineLocs[5].height / 2);
                ctx.lineTo(timelineLocs[6].x + timelineLocs[6].width / 2, timelineLocs[6].groundY - timelineLocs[6].height / 2);
                ctx.stroke();

                signs.forEach(drawSign);

                ctx.font = `${16 * scaleX}px Inter`;
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText('2013–2017', 10 * scaleX, 620 * scaleY);
                ctx.fillText('2018–2022', 10 * scaleX, 420 * scaleY);
                ctx.fillText('2023–Present', 10 * scaleX, 220 * scaleY);

                ctx.fillStyle = 'rgba(60, 60, 80, 0.8)';
                ctx.fillRect(0, 650 * scaleY, gameContainer.clientWidth, 150 * scaleY);
                ctx.fillStyle = '#3A3A4A';
                ctx.fillRect(0, 650 * scaleY, gameContainer.clientWidth, 150 * scaleY);
                for (let y = 700 * scaleY; y <= 740 * scaleY; y += 20 * scaleY) {
                    ctx.fillStyle = '#2A2A3A';
                    ctx.fillRect(0, y - 5 * scaleY, gameContainer.clientWidth, 2 * scaleY);
                    ctx.fillStyle = '#FFC107';
                    ctx.fillRect(0, y - 3 * scaleY, gameContainer.clientWidth, 2 * scaleY);
                }
                undergroundTrains.forEach(drawUndergroundTrain);
                undergroundSigns.forEach(drawSign);
                for (let x = 50 * scaleX; x < gameContainer.clientWidth; x += 100 * scaleX) {
                    ctx.fillStyle = '#FFFFE0';
                    ctx.beginPath();
                    ctx.arc(x, 670 * scaleY, 5 * scaleX, 0, Math.PI * 2);
                    ctx.fill();
                }

                cars.forEach(drawCar);

                ctx.font = `${18 * scaleX}px Inter`;
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(`XP: ${xp}/100`, 10 * scaleX, 20 * scaleY);

                const progressFill = document.getElementById('progress-fill');
                const progressPercent = (visited.size / (locations.length - 1)) * 100;
                progressFill.style.width = `${progressPercent}%`;

                if (nearestLoc && minDistance < 100 * scaleX) {
                    tooltip.style.display = 'block';
                    tooltip.textContent = nearestLoc.tooltip;
                    tooltip.style.left = `${nearestLoc.x + nearestLoc.width + 10 * scaleX}px`;
                    tooltip.style.top = `${nearestLoc.groundY - nearestLoc.height}px`;
                } else {
                    tooltip.style.display = 'none';
                }

                ctx.fillStyle = '#FFDAB9';
                ctx.fillRect(player.x + 6 * scaleX, player.y + 6 * scaleY, 12 * scaleX, 12 * scaleY);
                ctx.fillStyle = '#000000';
                ctx.fillRect(player.x + 6 * scaleX, player.y + 6 * scaleY, 12 * scaleX, 6 * scaleY);
                ctx.fillStyle = '#000000';
                ctx.fillRect(player.x + 6 * scaleX, player.y + 18 * scaleY, 12 * scaleX, 18 * scaleY);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(player.x + 9 * scaleX, player.y + 18 * scaleY, 6 * scaleX, 12 * scaleY);
                ctx.fillStyle = '#00DDEB';
                ctx.fillRect(player.x + 10.5 * scaleX, player.y + 24 * scaleY, 3 * scaleX, 6 * scaleY);

                requestAnimationFrame(update);
            } catch (error) {
                console.error('Error in update loop:', error);
            }
        }

        function checkInteraction() {
            locations.forEach(loc => {
                if (loc.locked && !achievementsUnlocked) return;
                const dx = player.x + player.width / 2 - (loc.x + loc.width / 2);
                const dy = player.y + player.height / 2 - (loc.groundY - loc.height / 2);
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 50 * scaleX) {
                    const popup = document.getElementById(loc.id + '-popup');
                    if (popup) document.getElementById(loc.id + '-popup').classList.add('active');
                    else console.error(`Popup for ${loc.id} not found`);
                }
            });
        }

        window.addEventListener('storage', (event) => {
            if (event.key === 'resumeLocations') {
                savedLocations = JSON.parse(event.newValue) || savedLocations;
                locations.length = 0;
                savedLocations.forEach(loc => {
                    locations.push({
                        ...loc,
                        radiating: false,
                        pulseVisited: false,
                        draw: drawBuilding,
                        tooltip: loc.startYear ? `${loc.startYear}${loc.endYear === 'Present' ? '–Present' : loc.endYear ? '–' + loc.endYear : ''}: ${loc.title}` : loc.title
                    });
                });

                popupsContainer.innerHTML = '';
                locations.forEach(loc => {
                    const popup = document.createElement('div');
                    popup.className = 'popup';
                    popup.id = loc.id + '-popup';
                    popup.innerHTML = `
                        <button class="close-btn" onclick="closePopup('${loc.id}-popup')">×</button>
                        <h2>${loc.title}</h2>
                        ${loc.content}
                    `;
                    popupsContainer.appendChild(popup);
                });
            }
        });

        update();
    </script>
</body>
</html>
